{% extends 'mirror/base.html' %}

{% block title %}Start New Debate - Tactical Empathy{% endblock %}

{% block extra_css %}
{# This is the same CSS from the conversation detail page for a consistent look #}
<style>
    .chat-window {
        display: flex;
        flex-direction: column;
        height: 80vh;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        background-color: #f7f7f7;
    }
    .chat-header {
        background-color: #005E54;
        color: white;
        padding: 0.75rem 1rem;
        flex-shrink: 0;
    }
    .chat-header h5 {
        margin: 0;
        font-weight: bold;
    }
    .chat-body {
        flex-grow: 1;
        padding: 2rem; /* More padding for the form */
        overflow-y: auto;
        background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        background-color: #E5DDD5;
    }
    /* Style form elements to look good on the chat background */
    .form-container {
        background-color: rgba(255, 255, 255, 0.9);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}


{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">

            <div class="chat-window">
                <div class="chat-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Start a New Debate
                    </h5>
                </div>

                <div class="chat-body d-flex align-items-center justify-content-center">
                    <div class="form-container w-100">
                        <p class="text-muted text-center mb-4">
                            Enter your opening statement. The bot will automatically take an opposing stance to begin the debate.
                        </p>
                        
                        <form id="debate-form">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="message" class="form-label fw-bold">Your Opening Statement</label>
                                <textarea 
                                    class="form-control" 
                                    id="message" 
                                    name="message" 
                                    rows="5" 
                                    placeholder="e.g., 'I believe that pineapple is a perfectly valid pizza topping.'"
                                    required
                                ></textarea>
                            </div>
                            
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="start-btn">
                                    <i class="fas fa-rocket"></i> Start Debate
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
             <div class="d-flex justify-content-start mt-3">
                <a href="{% url 'list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to All Debates
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Handle the initial debate form submission.
// I've removed the unused JS for the hidden chat since you redirect the user.
document.getElementById('debate-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = document.getElementById('message').value.trim();
    if (!message) return;
    
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    
    // Get CSRF token from the form
    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch('/api/v1/debate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Add CSRF token for security
            },
            body: JSON.stringify({
                user_message: message
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // On success, redirect to the new conversation's detail page
            const conversationId = data.conversation_id;
            window.location.href = `/web/conversation/${conversationId}/`;
        } else {
            alert('Error: ' + (data.error || 'Failed to start debate'));
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Debate';
        }
    } catch (error) {
        alert('Network error: ' + error.message);
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Debate';
    }
});
</script>
{% endblock %}